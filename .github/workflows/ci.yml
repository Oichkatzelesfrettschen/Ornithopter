name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [pico32_release, pico32_debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        pip install --upgrade platformio
        pio --version
    
    - name: Build firmware
      run: pio run -e ${{ matrix.env }}
    
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v3
      with:
        name: firmware-${{ matrix.env }}
        path: .pio/build/${{ matrix.env }}/firmware.bin
        retention-days: 30

  size-analysis:
    name: Binary Size Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: pip install --upgrade platformio
    
    - name: Build and analyze size
      run: |
        pio run -e pico32_release
        pio run --target size -e pico32_release

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: pip install --upgrade platformio
    
    - name: Run cppcheck
      continue-on-error: true
      run: |
        cppcheck --enable=all --suppress=missingInclude \
          --inline-suppr --error-exitcode=1 \
          -I include/ src/ || true
    
    - name: Run PlatformIO check
      continue-on-error: true
      run: |
        pio check -e check --skip-packages || true

  formal-verification:
    name: Formal Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Z3 solver
      run: pip install z3-solver
    
    - name: Run Z3 verification
      run: python3 docs/formal_verification/verify_control.py
    
    - name: Upload verification results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: verification-results
        path: |
          docs/formal_verification/*.log
        retention-days: 30

  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
    
    - name: Generate documentation
      continue-on-error: true
      run: |
        if [ -f Doxyfile ]; then
          doxygen Doxyfile
        else
          echo "Doxyfile not found, skipping documentation generation"
        fi
    
    - name: Upload documentation
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: documentation
        path: docs/html/
        retention-days: 30

  report:
    name: Generate Build Report
    runs-on: ubuntu-latest
    needs: [build, static-analysis, formal-verification]
    if: always()
    
    steps:
    - name: Create summary
      run: |
        echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Formal Verification: ${{ needs.formal-verification.result }}" >> $GITHUB_STEP_SUMMARY
